#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–ø—Ä–∞–≤–∫–∏
show_help() {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–û–ü–¶–ò–ò]"
    echo ""
    echo "–û–ü–¶–ò–ò:"
    echo "  -y, --yes     –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞)"
    echo "  -d, --dry-run –ü—Ä–æ–±–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ)"
    echo "  -h, --help    –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü–†–ò–ú–ï–†–´:"
    echo "  $0            # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º"
    echo "  $0 --yes      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤"
    echo "  $0 --dry-run  # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
AUTO_YES=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -y|--yes)
            AUTO_YES=true
            shift
            ;;
        -d|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
            show_help
            exit 1
            ;;
    esac
done

echo "üîÑ –°–±—Ä–æ—Å –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤"
echo ""

if [ "$DRY_RUN" = true ]; then
    echo "üîç –ü–†–û–ë–ù–´–ô –ó–ê–ü–£–°–ö - –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã"
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if [ ! -f "../backend/florist.sqlite" ]; then
    echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ../backend/florist.sqlite"
    exit 1
fi

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–µ—Å–ª–∏ –Ω–µ auto-yes)
if [ "$AUTO_YES" != true ] && [ "$DRY_RUN" != true ]; then
    read -p "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–µ ID –∑–∞–∫–∞–∑–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm

    if [ "$confirm" != "yes" ]; then
        echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
        exit 0
    fi
fi

echo ""
echo "üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:"
echo "   1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏"
echo "   2. –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É order_ids"
echo "   3. –û—á–∏—Å—Ç–∏—Ç—å order_ids_backup.json"
echo "   4. –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è ID"
echo "   5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
echo ""

if [ "$DRY_RUN" = true ]; then
    echo "‚úÖ –ü–†–û–ë–ù–´–ô –ó–ê–ü–£–°–ö –ó–ê–í–ï–†–®–ï–ù"
    echo "   –î–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã"
    exit 0
fi

# –°–æ–∑–¥–∞–µ–º timestamp –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="../order_ids_reset_backup_$TIMESTAMP"

echo "üìÅ –°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤: $BACKUP_DIR"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
mkdir -p "$BACKUP_DIR"

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
cp ../backend/florist.sqlite "$BACKUP_DIR/florist_backup_$TIMESTAMP.sqlite"

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–æ–≤
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–æ–≤..."
cp ../backend/order_ids_backup.json "$BACKUP_DIR/order_ids_backup_$TIMESTAMP.json" 2>/dev/null || true

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤..."
cp -r ../logs/id_assignments "$BACKUP_DIR/id_assignments_logs_$TIMESTAMP" 2>/dev/null || true

echo ""
echo "üóëÔ∏è  –í—ã–ø–æ–ª–Ω—è—é —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö..."

# –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É order_ids –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo "üóëÔ∏è  –û—á–∏—â–∞—é —Ç–∞–±–ª–∏—Ü—É order_ids..."
sqlite3 ../backend/florist.sqlite "DELETE FROM order_ids;"

if [ $? -eq 0 ]; then
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ order_ids –æ—á–∏—â–µ–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã order_ids"
    exit 1
fi

# –û—á–∏—â–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é ID
echo "üóëÔ∏è  –û—á–∏—â–∞—é order_ids_backup.json..."
echo "[]" > ../backend/order_ids_backup.json

# –û—á–∏—â–∞–µ–º –ª–æ–≥–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è ID
echo "üóëÔ∏è  –û—á–∏—â–∞—é –ª–æ–≥–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è ID..."
find ../logs -name "id_assignments_*.log" -delete

echo ""
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±—Ä–æ—Å–∞:"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
COUNT=$(sqlite3 ../backend/florist.sqlite "SELECT COUNT(*) FROM order_ids;")
echo "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ order_ids: $COUNT"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
echo "üìä –†–∞–∑–º–µ—Ä —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π: $BACKUP_SIZE"

echo ""
echo "‚úÖ –°–ë–†–û–° –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
echo "üìÅ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $BACKUP_DIR"
echo ""
echo "üîÑ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –ø–æ–ª—É—á–∏—Ç ID: A001"
echo "üìÖ –í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –Ω–∞ 001 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ –æ—á–∏—â–µ–Ω–æ:"
echo "   ‚úì –¢–∞–±–ª–∏—Ü–∞ order_ids –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "   ‚úì –§–∞–π–ª order_ids_backup.json"
echo "   ‚úì –õ–æ–≥–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è ID"
echo ""
echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: pm2 restart florist-backend"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É: curl http://localhost:3000/api/ping"
echo "   3. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã"